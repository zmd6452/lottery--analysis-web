<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>4D Tracker Zip Builder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h1>Generate Malaysia 4D Interactive Tracker Zip</h1>
  <button id="buildBtn">Download ZIP</button>
  <p id="status"></p>

  <script>
    const SHEET_JSON_URL = 
      "https://opensheet.elk.sh/16NJ3an81qlkX7HWcLOXnxQc-x4GXvpk_KbHXgVEVSn0/Responses";

    document.getElementById('buildBtn').onclick = async () => {
      document.getElementById('status').innerText = "Fetching sheet data...";
      const res = await fetch(SHEET_JSON_URL);
      const rows = await res.json();

      document.getElementById('status').innerText = "Splitting into CSV files...";

      function toCSV(data) {
        if (!data.length) return "";
        const header = Object.keys(data[0]).join(",");
        const lines = data.map(r => {
          const spec = (r.Special || "").split(",").map(n=>n.trim()).join("|");
          const cons = (r.Consolation || "").split(",").map(n=>n.trim()).join("|");
          return `${r.Date},${r.Company},${r.First},${r.Second},${r.Third},${spec},${cons}`;
        });
        return header + "\n" + lines.join("\n");
      }

      const magnum = rows.filter(r => r.Company && r.Company.toLowerCase() === "magnum");
      const toto   = rows.filter(r => r.Company && r.Company.toLowerCase() === "toto");
      const damacai= rows.filter(r => r.Company && r.Company.toLowerCase() === "damacai");

      const zip = new JSZip();

      // Add CSVs
      zip.file("data/magnum.csv", toCSV(magnum));
      zip.file("data/toto.csv",   toCSV(toto));
      zip.file("data/damacai.csv",toCSV(damacai));

      document.getElementById('status').innerText = "Adding template files...";

      // Add index.html
      zip.file("index.html", `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Malaysia 4D Interactive Tracker</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family:sans-serif; padding:20px; }
    h1,h2 { text-align:center; }
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ccc;padding:6px;text-align:center;}
    button{padding:10px;margin:5px;}
    #charts{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;}
    canvas{background:white;border-radius:8px;padding:10px;}
  </style>
</head>
<body>
<h1>ðŸŽ° Malaysia 4D Interactive Tracker</h1>
<div style="text-align:center;">
<button onclick="loadResults('magnum')">Magnum</button>
<button onclick="loadResults('toto')">Toto</button>
<button onclick="loadResults('damacai')">Da Ma Cai</button>
</div>
<div style="text-align:center;">
<input id="search" placeholder="Search number..." oninput="debouncedSearch()">
<button onclick="exportCSV()">Export CSV</button>
</div>
<h2 id="title"></h2>
<table id="results"><tr><td colspan="6">No data</td></tr></table>
<h2>Charts & Insights</h2>
<div id="charts">
<canvas id="freqChart" width="400" height="300"></canvas>
<canvas id="aiChart" width="400" height="300"></canvas>
<canvas id="clusterChart" width="400" height="300"></canvas>
<canvas id="backtestChart" width="400" height="300"></canvas>
</div>
<script>
// parse CSV
function parseCSV(text){
  const lines=text.trim().split(/\\r?\\n/);
  const header=lines.shift().split(',');
  return lines.map(l=>{const obj={};const vals=l.split(',');header.forEach((h,i)=>obj[h]=vals[i]);obj.Special=obj.Special?obj.Special.split("|"):[];obj.Consolation=obj.Consolation?obj.Consolation.split("|"):[];return obj;});
}
async function fetchCSV(path){
  try{const r=await fetch(path);return parseCSV(await r.text());}catch{return [];}
}
async function loadLocal(type){
  const mag = await fetchCSV("./data/magnum.csv");
  const toto= await fetchCSV("./data/toto.csv");
  const dam = await fetchCSV("./data/damacai.csv");
  if(type==="magnum") return mag;
  if(type==="toto") return toto;
  if(type==="damacai") return dam;
  return [];
}

let currentData=[],currentType="",searchTimeout;
async function loadResults(type){
  currentType=type;
  currentData = await loadLocal(type);
  document.getElementById("title").innerText=\`\${type.toUpperCase()} (\${currentData.length} draws)\`;
  renderTable(currentData);
  updateFreqChart(currentData);
}
// render
function renderTable(data){
  const t=document.getElementById("results");
  t.innerHTML="<tr><th>Date</th><th>1st</th><th>2nd</th><th>3rd</th><th>Special</th><th>Consolation</th></tr>";
  data.forEach(d=>{const row=t.insertRow();row.innerHTML=\`<td>\${d.Date}</td><td>\${d.First}</td><td>\${d.Second}</td><td>\${d.Third}</td><td>\${d.Special.join(", ")}</td><td>\${d.Consolation.join(", ")}</td>\`;});
}
// search & export
function debouncedSearch(){clearTimeout(searchTimeout);searchTimeout=setTimeout(searchNumber,300);}
function searchNumber(){const q=document.getElementById("search").value.toLowerCase();renderTable(currentData.filter(d=>[d.First,d.Second,d.Third,...d.Special,...d.Consolation].some(n=>n.toLowerCase().includes(q))));}
function exportCSV(){if(!currentData.length)return;const out=[["Date","1st","2nd","3rd","Special","Consolation"],...currentData.map(d=>[d.Date,d.First,d.Second,d.Third,d.Special.join("|"),d.Consolation.join("|")])].map(r=>r.join(","));const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([out.join("\\n")],{type:"text/csv"}));a.download=\`4D-\${currentType}.csv\`;a.click();}
let freqChart;
function updateFreqChart(data){
  const freq={};
  data.forEach(d=>[d.First,d.Second,d.Third,...d.Special,...d.Consolation].forEach(n=>freq[n]=(freq[n]||0)+1));
  const top=Object.entries(freq).sort(([,a],[,b])=>b-a).slice(0,10);
  const labels=top.map(e=>e[0]),values=top.map(e=>e[1]);
  if(freqChart)freqChart.destroy();
  freqChart=new Chart(document.getElementById("freqChart"),{type:"bar",data:{labels,datasets:[{label:"Frequency",data:values,backgroundColor:"#007bff"}]}});
}
</script>
</body>
</html>
      `);

      document.getElementById('status').innerText = "Generating ZIP fileâ€¦";

      zip.generateAsync({type:"blob"}).then(content => {
        saveAs(content, "malaysia-4d-interactive.zip");
        document.getElementById('status').innerText = "âœ… Download ready!";
      });
    };
  </script>
</body>
</html>
